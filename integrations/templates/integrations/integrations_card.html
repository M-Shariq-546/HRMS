{% load i18n %}
{% load basefilters recruitmentfilters horillafilters dict_extras %}
{% load static %}

<style>
  .integration-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
  }

  .integration-modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    width: 400px;
    position: relative;
  }

  .integration-modal-close {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 22px;
    cursor: pointer;
  }

  .integration-modal-content label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }

  .integration-modal-content input[type="text"],
  .integration-modal-content input[type="password"] {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
  }

  .integration-modal-content button {
    background: #ef4444;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
  }
  .integrations-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .integrations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .integration-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .integration-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .integration-header {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
  }

  .integration-logo {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    margin-right: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    color: white;
  }

  .slack-logo {
    background: linear-gradient(135deg, #4A154B, #611f69);
  }

  .documenso-logo {
    background: linear-gradient(135deg, #10B981, #059669);
  }

  .gmail-logo {
    background: linear-gradient(135deg, #EA4335, #D93025);
  }

  .logo-wise {
    background: linear-gradient(135deg, #00B9FF, #0099CC);
  }

  .integration-info {
    flex: 1;
  }

  .integration-name {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    text-transform: capitalize;
  }

  .integration-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-connected {
    background-color: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .alert-error {
    background-color: #ffe3e3;
    color: #b00020;
    border-left: 5px solid #b00020;
    padding: 12px 16px;
    margin-bottom: 16px;
    border-radius: 4px;
    font-size: 14px;
    position: relative;
  }
  
  .alert-error .close-alert {
    position: absolute;
    top: 6px;
    right: 12px;
    cursor: pointer;
    font-weight: bold;
  }  

  .status-disconnected {
    background-color: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .integration-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
  }

  .btn-connect {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-connect:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  .btn-disconnect {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-disconnect:hover {
    background: #dc2626;
    transform: translateY(-1px);
  }

  .btn-settings {
    background: transparent;
    color: #6b7280;
    border: 1px solid #d1d5db;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn-settings:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .integration-description {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 16px;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .integrations-grid {
      grid-template-columns: 1fr;
    }
    
    .integration-card {
      padding: 16px;
    }
    
    .integration-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    
    .integration-logo {
      margin-right: 0;
    }
  }
/** Documenso Settings Popup */
/* Spinner loader inside modal */
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Modal overlay and container */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 24px;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-30px);}
  to { opacity: 1; transform: translateY(0);}
}

/* Close button styling */
.close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 24px;
  border: none;
  background: none;
  cursor: pointer;
  color: #888;
}

.close-btn:hover {
  color: #000;
}

/* Template section styling */
.template-section {
  margin-top: 16px;
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
}

.template-header {
  background: #212121;
  color: #fff;
  padding: 12px 16px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.template-header:hover {
  background: #1b1b1b;
}

.collapser-icon {
  font-size: 16px;
  transition: transform 0.3s ease;
}

.collapsed .collapser-icon {
  transform: rotate(-90deg);
}

/* Template body + table */
.template-body {
  display: none;
  padding: 0 16px 16px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

th, td {
  padding: 12px 16px;
  text-align: left;
}

th {
  background: #f0f0f0;
}

tr:not(:last-child) {
  border-bottom: 1px solid #eee;
}
</style>

<div class="integrations-container">
  <div class="integrations-grid">
    <!-- Slack Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo slack-logo">
          <ion-icon name="logo-slack"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Slack</div>
          {% if integration_status.slack.is_connected %}
          <div class="integration-status status-connected">
            Connected
          </div>
          {% else %}
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
          {% endif %}
        </div>
      </div>

      <div class="integration-description">
        Connect your Slack workspace to receive real-time notifications and manage all team communications from one central hub.
      </div>
      {% if integration_status.slack.is_connected %}
      <div class="integration-actions">
        <a href="{% url 'integrations:disconnect_integration' 'slack' %}" class="btn-disconnect" onclick="return confirm('Are you sure you want to disconnect Slack?')">
          <ion-icon name="close-circle-outline"></ion-icon>
          Disconnect
        </a>
      </div>      
      {% else %}
      <div class="integration-actions">
        <a href="#" class="btn-connect" data-integration="slack">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Documenso Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo documenso-logo">
          <ion-icon name="document-text"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Documenso</div>
          {% if integration_status.documenso.is_connected %}
          <div class="integration-status status-connected">
            Connected
          </div>
          {% else %}
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
          {% endif %}
        </div>
      </div>

      <div class="integration-description">
        Connect your Documenso account to enable document signing, approvals, and streamline workflow automation across your team.
      </div>

      {% if integration_status.documenso.is_connected %}
      <div class="integration-actions">
        <a href="{% url 'integrations:disconnect_integration' 'documenso' %}" class="btn-disconnect" onclick="return confirm('Are you sure you want to disconnect Documenso?')">
          <ion-icon name="close-circle-outline"></ion-icon>
          Disconnect
        </a>
        <button class="btn-settings documenso-settings-button" title="{% trans 'Settings' %}">
          <ion-icon name="settings-outline"></ion-icon>
        </button>
      </div>

      {% else %}
      <div class="integration-actions">
        <a href="#" class="btn-connect" data-integration="documenso">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Wise Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo logo-wise">
          <ion-icon name="card-outline"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Wise</div>
          {% if integration_status.wise.is_connected %}
          <div class="integration-status status-connected">
            Connected
          </div>
          {% else %}
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
          {% endif %}
        </div>
      </div>

      <div class="integration-description">
        Connect your Wise account to enable global payments, transfers, and automate payroll with speed and security.
      </div>

      {% if integration_status.wise.is_connected %}
      <div class="integration-actions">
        <a href="{% url 'integrations:disconnect_integration' 'wise' %}" class="btn-disconnect" onclick="return confirm('Are you sure you want to disconnect Wise?')">
          <ion-icon name="close-circle-outline"></ion-icon>
          Disconnect
        </a>
        <button class="btn-settings wise-settings-button" title="Settings">
          <ion-icon name="settings-outline"></ion-icon>
        </button>
        <button class="btn-transactions wise-transactions-button" title="See Transactions" style="background: #00B9FF; color: white; border: none; padding: 8px 8px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
          <ion-icon name="cash-outline"></ion-icon>
          Transactions
        </button>
      </div>
      {% else %}
      <div class="integration-actions">
        <a href="#" class="btn-connect" data-integration="wise">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </a>
      </div>
      {% endif %}
    </div>

<!-- Wise Settings Modal -->
<div id="wiseSettingsModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeWiseModal()">&times;</button>
    <h2 style='color: #000; font-weight: bold;'>Wise Recipients</h2>
    <div id="wise-recipients-list" style="margin-bottom: 24px;">
      <div class="spinner" id="wise-recipients-spinner" style="display:none;"></div>
      <ul id="wise-recipients-ul"></ul>
    </div>
    <form id="wise-add-recipient-form">
      <div id="wise-recipient-message" style="margin-top: 12px;"></div>
      <h3>Add New Recipient</h3>
      <label for="wise-recipient-name">Name:</label>
      <input type="text" id="wise-name" name="wise-name" required class="oh-input w-100" />
      <label for="wise-email">Email:</label>
      <input type="email" id="wise-email" name="wise-email" required class="oh-input w-100" />
      <label for="wise-iban">IBAN:</label>
      <input type="text" id="wise-iban" name="wise-iban" required class="oh-input w-100" />
      <label for="wise-country">Country Code:</label>
      <input type="text" id="wise-country" name="wise-country" required class="oh-input w-100" />
      <label for="wise-currency">Currency:</label>
      <input type="text" id="wise-currency" name="wise-currency" required class="oh-input w-100" />
      <button type="submit" class="oh-btn oh-btn--secondary oh-btn--shadow" style="margin-top: 12px;">Add Recipient</button>
    </form>
  </div>
</div>

<!-- Wise Transfers Modal (Recent Transfers) -->
<div id="wiseTransfersModal" class="modal">
  <div class="modal-content wise-transfers-modal-content">
    <button class="close-btn" onclick="closeWiseTransfersModal()">&times;</button>
    <hr style="margin: 32px 0 16px 0;">
    <h2 style="color: #000; font-weight: bold; margin-bottom: 12px;">Recent Transfers</h2>
    <div id="wise-transfers-list">
      <div class="spinner" id="wise-transfers-spinner" style="display:none;"></div>
      <div class="wise-transfers-table-wrapper">
        <table id="wise-transfers-table" style="display:none; width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>Status</th>
              <th>Transfer ID</th>
              <th>Recipient</th>
              <th>Date/Time</th>
              <th>Amount</th>
              <th>Payroll Ref</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="wise-transfers-empty" style="display:none; color:#888; text-align:center;">No transfers found.</div>
    </div>
  </div>
</div>

<style>
#wiseTransfersModal .modal-content.wise-transfers-modal-content {
  max-width: 900px;
  width: 95vw;
  padding: 32px 24px;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  position: relative;
  animation: fadeIn 0.3s;
}
#wiseTransfersModal .wise-transfers-table-wrapper {
  overflow-x: auto;
  max-height: 60vh;
}
#wiseTransfersModal th, #wiseTransfersModal td {
  border-bottom: 1px solid #f1f5f9;
  padding: 12px 10px;
  font-size: 15px;
  vertical-align: middle;
}
#wiseTransfersModal th {
  background: #f8fafc;
  font-weight: 600;
}
#wiseTransfersModal tr:hover td {
  background: #f0f9ff;
  transition: background 0.2s;
}
#wiseTransfersModal .close-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 24px;
  border: none;
  background: none;
  cursor: pointer;
  color: #888;
}
#wiseTransfersModal .close-btn:hover {
  color: #000;
}
@media (max-width: 900px) {
  #wiseTransfersModal .modal-content.wise-transfers-modal-content {
    max-width: 98vw;
    padding: 18px 4px;
  }
}
@media (max-width: 600px) {
  #wiseTransfersModal .modal-content.wise-transfers-modal-content {
    padding: 8px 0 0 0;
    border-radius: 8px;
  }
  #wiseTransfersModal th, #wiseTransfersModal td {
    font-size: 12px;
    padding: 7px 4px;
  }
  #wiseTransfersModal h2 {
    font-size: 1.1rem !important;
    margin-bottom: 8px !important;
    margin-left:2%;
  }
  #wiseTransfersModal .close-btn {
    top: 8px;
    right: 8px;
    font-size: 20px;
  }
  #wiseTransfersModal .wise-transfers-table-wrapper {
    max-height: 45vh;
  }
}
</style>


{% comment %} <!-- Microsoft Teams Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo" style="background: linear-gradient(135deg, #6264A7, #464775);">
          <ion-icon name="people"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Microsoft Teams</div>
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
        </div>
      </div>

      <div class="integration-description">
        Connect your Microsoft Teams workspace for team collaboration and notifications.
      </div>

      <div class="integration-actions">
        <button class="btn-connect">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </button>
      </div>
    </div>

    <!-- Zoom Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo" style="background: linear-gradient(135deg, #2D8CFF, #1A73E8);">
          <ion-icon name="videocam"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Zoom</div>
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
        </div>
      </div>

      <div class="integration-description">
        Integrate with Zoom for video meetings and conference scheduling.
      </div>

      <div class="integration-actions">
        <button class="btn-connect">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </button>
      </div>
    </div>

    <!-- Google Calendar Integration Card -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo" style="background: linear-gradient(135deg, #4285F4, #1967D2);">
          <ion-icon name="calendar"></ion-icon>
        </div>
        
        <div class="integration-info">
          <div class="integration-name">Google Calendar</div>
          <div class="integration-status status-disconnected">
            Disconnected
          </div>
        </div>
      </div>

      <div class="integration-description">
        Sync your Google Calendar for meeting scheduling and event management.
      </div>

      <div class="integration-actions">
        <button class="btn-connect">
          <ion-icon name="link-outline"></ion-icon>
          Connect
        </button>
      </div>
    </div> {% endcomment %}
  </div>
</div>


<!-- Documenso Connect Popup -->
{% comment %} <div id="documenso-integration-modal" class="integration-modal" style="display: none;">
  <div class="integration-modal-content">
    <span class="close-btn" onclick="closeDocumensoModal()">&times;</span>
    <h2>Connect Documenso</h2>
    <form id="documenso-integration-form">
      <label for="documenso-api-key">API Key:</label>
      <input type="text" id="documenso-api-key" name="documenso_api_key" class="oh-input w-100" required />
      <button type="button" onclick="submitDocumensoIntegration()">Submit</button>
    </form>
  </div>
</div> {% endcomment %}


<!-- Slack Connect Popup -->
<div id="integration-modal" class="integration-modal" style="display: none;">
  <div class="integration-modal-content">
    <span class="integration-modal-close" onclick="closeIntegrationModal()">&times;</span>
    <div id="integration-modal-body"></div>
  </div>
</div>

<div id="templateModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h2 style='color: #000; font-weight: bold;'>Select Documenso Fields</h2>
    
    <!-- Notification Message Section -->
    <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
      <p style="margin-bottom: 8px; color: black; font-size: 16px; font-weight: bold;">Enter a message that will be sent with document notifications.</p>
      <textarea 
        id="notification-message" 
        placeholder="Enter your notification message here..."
        style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
      ></textarea>
    </div>
    
    <!-- Hours Selection Section -->
    <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
      <p style="margin-bottom: 8px; color: black; font-size: 16px; font-weight: bold;">Select the number of hours for document processing:</p>
      <select 
        id="processing-hours" 
        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
      >
        <option value="12" selected>12 hours</option>
        <option value="24">24 hours</option>
        <option value="48">48 hours</option>
        <option value="58">58 hours</option>
      </select>
    </div>
    
    <!-- TinyMCE Script for notification message -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>
    <script>
      function initializeNotificationTinyMCE() {
        tinymce.init({
          selector: '#notification-message',
          height: 200,
          menubar: false,
          plugins: 'autolink lists link image charmap print preview media',
          toolbar: 'undo redo | variables',
          branding: false,
          promotion: false,
          extended_valid_elements: '*[*]',
          valid_children: '+body[style]',
          external_plugins: {},
          init_instance_callback: function(editor) {
            console.log('Notification TinyMCE initialized successfully');
          },
          setup: function (editor) {
            // Define available variables for notification message
            var notificationVariables = [
              { 'id': 'document', 'label': 'Document Title' },
              { 'id': 'employee_name', 'label': 'Employee Name' },
            ];

            // Add variables button to toolbar
            editor.ui.registry.addMenuButton('variables', {
              text: 'Insert Variable',
              fetch: function (callback) {
                var items = notificationVariables.map(function (item) {
                  return {
                    type: 'menuitem',
                    text: item.label,
                    onAction: function () {
                      var openBrace = "{% templatetag openvariable %}";
                      var closeBrace = "{% templatetag closevariable %}";
                      editor.insertContent(openBrace + " " + item.id + " " + closeBrace);
                    }
                  };
                });
                callback(items);
              }
            });

            // Auto-completion on typing {
            editor.on("keyup", function (event) {
              var content = editor.getContent();
              var match = content.match(/\B{(\w*)$/);
              if (match) {
                var keyword = match[1];
                var pattern = new RegExp(keyword, "i");
                var filteredVariables = notificationVariables.filter(item => pattern.test(item.id));

                if (filteredVariables.length) {
                  var variable = filteredVariables[0];
                  var openBrace = "{% templatetag openvariable %}";
                  var closeBrace = "{% templatetag closevariable %}";
                  editor.setContent(content.replace(/\B{(\w*)$/, openBrace + " " + variable.id + " " + closeBrace));
                }
              }
            });
          }
        });
      }

      // Initialize TinyMCE when modal opens
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize TinyMCE after modal content is loaded
        setTimeout(function() {
          if (document.getElementById('notification-message')) {
            initializeNotificationTinyMCE();
          }
        }, 100);
      });

      // Also initialize TinyMCE when modal is opened
      function openModal() {
        console.log('Opening modal via AJAX...');
        document.getElementById('templateModal').style.display = 'block';
        document.body.classList.add('no-scroll');
        document.documentElement.classList.add('no-scroll');
      
        const loader = document.getElementById('template-loader');
        const container = document.getElementById('template-container');
        loader.style.display = 'block';
        container.innerHTML = ''; // clear content while loading
      
        fetch("{% url 'integrations:documenso_settings' %}")
          .then(res => res.json())
          .then(data => {
            templates = data.templates;
            loader.style.display = 'none';
            renderTemplateMapper(data);
            // Initialize TinyMCE after content is loaded
            setTimeout(function() {
              if (document.getElementById('notification-message')) {
                initializeNotificationTinyMCE();
              }
            }, 200);
          })
          .catch(err => {
            console.error('Failed to load templates', err);
            loader.innerHTML = '<p style="color: red;">Failed to load template data.</p>';
          });
      }
    </script>
    
    <div id="template-loader" style="text-align: center; display: none; margin-top: 20px;">
      <div class="spinner"></div>
      <p>Loading templates...</p>
    </div>
    <div id="template-container"></div>
  </div>
</div>


{% comment %} Documenso Settings Popup {% endcomment %}


<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.btn-connect').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        const service = this.dataset.integration;
        console.log('service =================', service)
        // Load form HTML via AJAX
        fetch(`/integrations/connect-integration/${service}/`)
          .then(response => response.text())
          .then(html => {
            document.getElementById('integration-modal-body').innerHTML = html;
            document.getElementById('integration-modal').style.display = 'flex';
            bindIntegrationFormSubmit(); // re-bind submit handler
          })
          .catch(err => {
            alert('Error loading form');
            console.error(err);
          });
      });
    });
  });

  function bindIntegrationFormSubmit() {
    const form = document.querySelector('#integration-modal-body form');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const action = form.getAttribute('action') || window.location.pathname;

      // Check if this is Slack OAuth flow
      if (action.includes('slack') || action.includes('connect-integration/slack')) {
        // For Slack OAuth, redirect the browser directly
        console.log('Redirecting to Slack OAuth:', action);
        window.location.href = action;
        return;
      }

      // For other integrations, use AJAX/fetch
      fetch(action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData,
        redirect: 'follow', // Explicitly follow redirects
      })
        .then(response => {
          if (response.redirected) {
            // For OAuth redirects, we need to navigate to the new URL
            window.location.href = response.url;
            return;
          } else if (response.ok) {
            return response.text();
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        })
        .then(html => {
          if (html) {
            document.getElementById('integration-modal-body').innerHTML = html;
            bindIntegrationFormSubmit();  // rebind again on error
          }
        })
        .catch((error) => {
          console.error('Form submission error:', error);
          alert('Submission failed. Please try again.');
        });
    });
  }

  function closeIntegrationModal() {
    document.getElementById('integration-modal').style.display = 'none';
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOMContentLoaded');
    const settingButtons = document.querySelectorAll('.documenso-settings-button');
    settingButtons.forEach(button => {
      button.addEventListener('click', openModal);
    });
  });
  const availableVariables = [
    { 'id': 'company_id', 'label': 'Company ID' },
    { 'id': 'company_email', 'label': 'Company Email' },
    { 'id': 'company_name', 'label': 'Company Name' },
    { 'id': 'company_phone', 'label': 'Company Phone' },
    { 'id': 'company_address', 'label': 'Company Address' },

    { 'id': 'employee_name', 'label': 'Employee Name' },
    { 'id': 'email', 'label': 'Employee Email' },
    { 'id': 'phone', 'label': 'Employee Phone' },
    { 'id': 'address', 'label': 'Employee Address' },
    { 'id': 'city', 'label': 'Employee City' },
    { 'id': 'state', 'label': 'Employee State' },
    { 'id': 'zip', 'label': 'Employee Zip' },
    { 'id': 'country', 'label': 'Employee Country' },
    { 'id': 'date_of_birth', 'label': 'Employee Date of Birth' },
    { 'id': 'gender', 'label': 'Employee Gender' },
    { 'id': 'marital_status', 'label': 'Employee Marital Status' },
    { 'id': 'salary', 'label': 'Salary' },
    { 'id': 'department_id', 'label': 'Department ID' },
    { 'id': 'job_position', 'label': 'Job Position' },
    { 'id': 'work_type', 'label': 'Work Type' },
    { 'id': 'employee_type', 'label': 'Employee Type' },
    { 'id': 'shift', 'label': 'Shift' },
  ];

  let templates = []; // will be populated from AJAX



  function closeModal() {
    const modal = document.getElementById('templateModal');
    if (modal) {
      modal.style.display = 'none';
    }
    document.body.classList.remove('no-scroll');
    document.documentElement.classList.remove('no-scroll');
  }

  function renderTemplateMapper(data) {
    const container = document.getElementById('template-container');
    container.innerHTML = '';
    
    // Set notification message if available
    const notificationMessage = data.notification_message || "";
    const editor = tinymce.get('notification-message');
    if (editor) {
      editor.setContent(notificationMessage);
    } else {
      document.getElementById('notification-message').value = notificationMessage;
    }

    // Set processing hours if available, default to 12
    const processingHours = data.processing_hours || "12";
    document.getElementById('processing-hours').value = processingHours;
  
    templates.forEach((template, index) => {
      const section = document.createElement('div');
      section.className = 'template-section';
  
      const savedMappings = data.saved_mappings?.[template.name] || {};
      console.log('savedMappings =================', savedMappings)
      const header = document.createElement('div');
      header.className = 'template-header';
      header.innerHTML = `
        ${template.name}
        <span class="collapser-icon">&#9654;</span>
      `;
  
      const body = document.createElement('div');
      body.className = 'template-body';
  
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Field</th>
            <th>Map to Variable</th>
          </tr>
        </thead>
        <tbody>
          ${template.fields.map(field => {
            const savedValue = savedMappings[field.id]; // Check if field was mapped
            const isChecked = savedValue ? 'checked' : '';
            const optionsHtml = availableVariables.map(v => {
              const selected = v.id === savedValue ? 'selected' : '';
              return `<option value="${v.id}" ${selected}>${v.label}</option>`;
            }).join('');

            return `
              <tr>
                <td>${field.label}</td>
                <td>
                  <select id="map-${field.id}-${index}">
                    <option value="">-- Select variable --</option>
                    ${optionsHtml}
                  </select>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;
      body.appendChild(table);
      section.appendChild(header);
      section.appendChild(body);
      container.appendChild(section);
  
      // Toggle collapse
      header.addEventListener('click', () => {
        const isOpen = body.style.display === 'block';
        body.style.display = isOpen ? 'none' : 'block';
        header.classList.toggle('collapsed', !isOpen);
      });
    });
  
    // Add a single Save button at the bottom of all sections
    const saveWrapper = document.createElement('div');
    saveWrapper.style.textAlign = 'right';
    saveWrapper.style.marginTop = '20px';
  
    const saveBtn = document.createElement('button');
    saveBtn.innerText = 'Save';
    saveBtn.className = 'oh-btn oh-btn--secondary oh-btn--shadow';
    saveBtn.onclick = () => {
      const selectedMappings = [];
      let allFieldsMapped = true;
      // Get notification message from TinyMCE editor
      let notificationMessage = "";
      const editor = tinymce.get('notification-message');
      if (editor) {
        notificationMessage = editor.getContent();
      } else {
        notificationMessage = document.getElementById('notification-message').value;
      }

      // Get processing hours value
      const processingHours = document.getElementById('processing-hours').value;

      templates.forEach((template, index) => {
        template.fields.forEach(field => {
          const select = document.getElementById(`map-${field.id}-${index}`);
          // Validation: If checkbox is not checked or select is empty, mark as not mapped
          if (!select?.value) {
            allFieldsMapped = false;
          }
          if (select?.value) {
            selectedMappings.push({
              template: template.name,
              fieldId: field.id,
              fieldLabel: field.label,
              variable: select.value
            });
          }
        });
      });

      // Remove existing alert if present
      document.querySelectorAll('.oh-wrapper').forEach(el => el.remove());

      if (!allFieldsMapped) {
        // Show alert message, do not reload or close modal
        const wrapper = document.createElement('div');
        window.location.reload();
        wrapper.className = 'oh-wrapper';
        wrapper.innerHTML = `
          <div class="oh-alert-container">
            <div class="oh-alert oh-alert--animated oh-alert--warning">
              Please map all fields before saving.
            </div>
          </div>
        `;
        document.body.prepend(wrapper);
        return;
      }

      // Check if notification message is empty
      if (!notificationMessage || notificationMessage.trim() === '') {
        const wrapper = document.createElement('div');
        wrapper.className = 'oh-wrapper';
        wrapper.innerHTML = `
          <div class="oh-alert-container">
            <div class="oh-alert oh-alert--animated oh-alert--warning">
              Notification message is required.
            </div>
          </div>
        `;
        window.location.reload();
        document.body.prepend(wrapper);
        return;
      }

      // ðŸ” Replace with your actual URL and add CSRF token if needed
      fetch("{% url 'integrations:save_documenso_mappings' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          template_mappings: selectedMappings,
          notification_message: notificationMessage,
          processing_hours: processingHours
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Data:', data);
      
        if (data.status === "success") {
          // Remove existing alert if present
          document.querySelectorAll(".oh-wrapper").forEach(el => el.remove());
          
          // Create the message element
          const wrapper = document.createElement("div");
          wrapper.className = "oh-wrapper";
          wrapper.innerHTML = `
            <div class="oh-alert-container">
              <div class="oh-alert oh-alert--animated oh-alert--success">
                ${data.message}
              </div>
            </div>
          `;
      
          // Append to body
          document.body.prepend(wrapper);
      
          // Close modal after 1 second
          setTimeout(() => {
            closeModal();  // Your existing modal closing logic
            window.location.href = '/integrations/integrations_react/';
          }, 1000);
        } else {
          // Handle error response
          document.querySelectorAll(".oh-wrapper").forEach(el => el.remove());
          const wrapper = document.createElement("div");
          wrapper.className = "oh-wrapper";
          wrapper.innerHTML = `
            <div class="oh-alert-container">
              <div class="oh-alert oh-alert--animated oh-alert--error">
                ${data.message || "An error occurred while saving mappings."}
              </div>
            </div>
          `;
          document.body.prepend(wrapper);
        }
      })
      .catch(error => {
        document.querySelectorAll(".oh-wrapper").forEach(el => el.remove());
        const wrapper = document.createElement("div");
        wrapper.className = "oh-wrapper";
        wrapper.innerHTML = `
          <div class="oh-alert-container">
            <div class="oh-alert oh-alert--animated oh-alert--error">
              An error occurred while saving mappings.
            </div>
          </div>
        `;
        document.body.prepend(wrapper);
        console.error("Error saving mappings:", error);
      });
    };
  
    saveWrapper.appendChild(saveBtn);
    container.appendChild(saveWrapper);
  }

  // Close when clicking outside modal
  window.onclick = function(event) {
    const modal = document.getElementById('templateModal');
    if (event.target === modal) {
      closeModal();
    }
  };
</script>
<script>
  function openIntegrationUpdateModal() {
    const modal = document.getElementById('integrationUpdateModal');
    if (modal) {
      modal.classList.add('active');
    }
  }
  function closeIntegrationUpdateModal() {
    const modal = document.getElementById('integrationUpdateModal');
    if (modal) {
      modal.classList.remove('active');
    }
  }
  const integrationUpdateModal = document.getElementById('integrationUpdateModal');
  if (integrationUpdateModal) {
    integrationUpdateModal.addEventListener('click', function(e) {
      if (e.target === this) closeIntegrationUpdateModal();
    });
  }
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.classList.contains('modal-body')) {
      openIntegrationUpdateModal();
    }
  });
</script>
<script>
  document.getElementById("wise-add-recipient-form").addEventListener("submit", function(e) {
    e.preventDefault();
    console.log('wise-add-recipient-form submitted');
    const name = document.getElementById("wise-name").value.trim();
    const email = document.getElementById("wise-email").value.trim();
    const iban = document.getElementById("wise-iban").value.trim();
    const country = document.getElementById("wise-country").value.trim();
    const currency = document.getElementById("wise-currency").value.trim();
  
    const messageDiv = document.getElementById("wise-recipient-message");
    const spinner = document.getElementById("wise-recipients-spinner");
  
    messageDiv.innerHTML = "";
    spinner.style.display = "block";
  
    fetch("{% url 'integrations:wise_add_recipient' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ name, email, iban, country, currency })
    })
    .then(res => res.json().then(data => ({ status: res.status, body: data })))
    .then(({ status, body }) => {
      spinner.style.display = "none";
  
      if (body.status === "success") {
        closeWiseModal();
        messageDiv.innerHTML = `
            <div class="alert alert-success" id="wise-success-alert">
              ${body.message || "Recipient added successfully."}
              <span class="close-alert" onclick="this.parentElement.style.display='none';">&times;</span>
            </div>`;
        setTimeout(() => {
          const alert = document.getElementById("wise-success-alert");
          if (alert) {
            alert.style.display = "none";
          }
        }, 2000);
      } else {
        messageDiv.innerHTML = `
          <div class="alert alert-error">
            ${body.message || "Something went wrong."}
            <span class="close-alert" onclick="this.parentElement.style.display='none';">&times;</span>
          </div>`;
      }
    })
    .catch(error => {
      spinner.style.display = "none";
      messageDiv.innerHTML = `
        <div class="alert alert-error closeable-alert">
          Server error. Please try again later.
          <span class="close-alert" onclick="this.parentElement.style.display='none';">&times;</span>
        </div>`;
    });
  });
  
  function closeWiseModal() {
    document.getElementById("wiseSettingsModal").style.display = "none";
  }
  
  window.onclick = function(event) {
    const modal = document.getElementById("wiseSettingsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  };
  
  function getCSRFToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : "";
  }
</script>
  

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Attach event to Wise settings button
    const wiseSettingButtons = document.querySelectorAll('.wise-settings-button');
    wiseSettingButtons.forEach(button => {
      button.addEventListener('click', function () {
        document.getElementById('wiseSettingsModal').style.display = 'block';
        document.body.classList.add('no-scroll');
        document.documentElement.classList.add('no-scroll');
        fetchWiseRecipients();
        fetchWiseTransfers();
      });
    });
    // Attach event to Wise transactions button
    const wiseTransactionsButtons = document.querySelectorAll('.wise-transactions-button');
    wiseTransactionsButtons.forEach(button => {
      button.addEventListener('click', function () {
        document.getElementById('wiseTransfersModal').style.display = 'block';
        document.body.classList.add('no-scroll');
        document.documentElement.classList.add('no-scroll');
        // Only show the transfers section
        fetchWiseTransfers();
        // Optionally scroll to the transfers section
        setTimeout(() => {
          const transfersSection = document.getElementById('wise-transfers-list');
          if (transfersSection) transfersSection.scrollIntoView({behavior: 'smooth'});
        }, 300);
      });
    });
  });

  // Fetch recipients via AJAX (existing)
  function fetchWiseRecipients() {
    const spinner = document.getElementById('wise-recipients-spinner');
    const ul = document.getElementById('wise-recipients-ul');
    spinner.style.display = 'block';
    ul.innerHTML = '';
    fetch('{% url "integrations:wise_recipients" %}')
      .then(res => res.json())
      .then(data => {
        spinner.style.display = 'none';
        if (data.recipients && data.recipients.length > 0) {
          data.recipients.forEach(r => {
            const li = document.createElement('li');
            li.textContent = `${r.name} (${r.email})`;
            ul.appendChild(li);
          });
        } else {
          ul.innerHTML = '<li>No recipients found.</li>';
        }
      })
      .catch(() => {
        spinner.style.display = 'none';
        ul.innerHTML = '<li style="color:red;">Failed to load recipients.</li>';
      });
  }

  // Fetch Wise transfers via AJAX
  function fetchWiseTransfers() {
    const spinner = document.getElementById('wise-transfers-spinner');
    const table = document.getElementById('wise-transfers-table');
    const tbody = table.querySelector('tbody');
    const empty = document.getElementById('wise-transfers-empty');
    spinner.style.display = 'block';
    table.style.display = 'none';
    empty.style.display = 'none';
    tbody.innerHTML = '';
    fetch('{% url "integrations:wise_transfers" %}')
      .then(res => res.json())
      .then(data => {
        spinner.style.display = 'none';
        if (data.status === 'success' && data.transfers && data.transfers.length > 0) {
          data.transfers.forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${t.status || ''}</td>
              <td>${t.id || ''}</td>
              <td>${t.recipient || ''}</td>
              <td>${t.created ? new Date(t.created).toLocaleString() : ''}</td>
              <td>${t.amount ? t.amount + ' ' + (t.currency || '') : ''}</td>
              <td>${t.payroll_reference ? `<a href="/payroll/view-payslip/${t.payroll_reference}/" target="_blank">${t.payroll_reference}</a>` : ''}</td>
              <td style="color: #b00020;">${t.error || ''}</td>
            `;
            tbody.appendChild(tr);
          });
          table.style.display = '';
        } else {
          empty.style.display = '';
        }
      })
      .catch(() => {
        spinner.style.display = 'none';
        empty.style.display = '';
      });
  }

  function closeWiseTransfersModal() {
    document.getElementById('wiseTransfersModal').style.display = 'none';
  }
</script>